<!DOCTYPE html>
<html lang="en" ng-app="rideMapApp">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- AngularJS -->
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.8.2/angular.min.js"></script>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <link rel="stylesheet" href="/style.css">

  <!-- Crosshair CSS -->
  <style>
    .map-container { position: relative; }
    .crosshair {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 20px;
      height: 20px;
      margin-left: -10px;
      margin-top: -10px;
      pointer-events: none;
      z-index: 1000;
    }
    .crosshair::before, .crosshair::after {
      content: '';
      position: absolute;
      background: #ff0000;
    }
    .crosshair::before {
      left: 50%;
      top: 0;
      width: 1px;
      height: 20px;
      transform: translateX(-50%);
    }
    .crosshair::after {
      left: 0;
      top: 50%;
      width: 20px;
      height: 1px;
      transform: translateY(-50%);
    }
  </style>
</head>
<body ng-controller="CheckpointController">
<div class="container p-4">
  <h3>References & Map</h3>

  <!-- Map with Crosshair Overlay -->
  <div class="map-container mb-4" style="width:100%; height:50vh;">
    <div id="map" style="width:100%; height:100%; border:4px solid #333; border-radius:8px;"></div>
    <div class="crosshair"></div>
  </div>

  <form ng-submit="saveCheckpoint()" class="mb-4">
    <div class="mb-3">
      <label class="form-label">Name</label>
      <input type="text" ng-model="checkpoint.name" class="form-control" placeholder="Enter checkpoint name" required>
    </div>
    <div class="mb-3">
      <label class="form-label">Number</label>
      <input type="number" ng-model="checkpoint.number" class="form-control" placeholder="Enter checkpoint number" required>
    </div>
    <button type="submit" class="btn btn-primary">Save Checkpoint</button>
  </form>

  <ul class="list-group">
    <li class="list-group-item" ng-repeat="cp in checkpoints">
      <strong>#{{cp.number}}</strong> {{cp.name}}
    </li>
  </ul>
</div>

<!-- Scripts: Leaflet & App Logic -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  angular.module('rideMapApp', [])
    .controller('CheckpointController', ['$scope', '$http', function($scope, $http) {
      $scope.checkpoint = { name: '', number: null };
      $scope.checkpoints = [];

      // Initialize map
      window.map = L.map('map').setView([0, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
      .addTo(window.map);

    // 2) 위치를 얻으면 뷰만 옮기기
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        pos => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          console.log(`내 위치: ${lat}, ${lng}`);
          $scope.$apply(() => {
            $scope.lat = lat;
            $scope.lng = lng;
          });
          // 맵 재초기화가 아니라 뷰만 이동
          window.map.setView([lat, lng], 13);
          L.marker([lat, lng]).addTo(window.map)
            .bindPopup("여기에 있습니다").openPopup();
        },
        err => console.error("위치 정보를 가져오지 못했습니다.", err),
        { enableHighAccuracy: true }
      );
    }
      // Load existing checkpoints and add markers
      $http.get('/api/checkpoints').then(function(response) {
        $scope.checkpoints = response.data;
        $scope.checkpoints.forEach(function(cp) {
          L.marker([cp.latitude, cp.longitude]).bindPopup('<b>' + cp.name + '</b><br/>#' + cp.number).addTo(map);
        });
      });

      // Save checkpoint at map center
      $scope.saveCheckpoint = function() {
        if (!$scope.checkpoint.name || $scope.checkpoint.number == null) return;
        var center = map.getCenter();
        var payload = {
          latitude: center.lat,
          longitude: center.lng,
          name: $scope.checkpoint.name,
          number: $scope.checkpoint.number
        };
        $http.post('/api/checkpoints', payload).then(function(res) {
          var cp = res.data;
          $scope.checkpoints.push(cp);
          L.marker([cp.latitude, cp.longitude]).bindPopup('<b>' + cp.name + '</b><br/>#' + cp.number).addTo(map);
          $scope.checkpoint = { name: '', number: null };
        });
      };
    }]);
</script>

<footer class="fixed-bottom bg-white text-muted p-2 text-center">© 2025 RIDE MAP</footer>
</body>
</html>
